trigger:
  branches:
    include:
      - main

variables:
  nodeVersion: '18.x'
  backendWorkingDirectory: 'BACKEND'
  frontendWorkingDirectory: 'FRONTEND'
  azureServiceConnection: 'sc-pruebas-a-errores'
  resourceGroupName: 'rg-errors-dev'
  deployInfra: 'false'
  location: 'eastus'
  environment: 'dev'
  namePrefix: 'errors'
  backendWebAppName: 'errors-dev-api'
  frontendStorageAccount: 'errorsdevfe'
  frontendApiBaseUrl: 'https://errors-dev-api.azurewebsites.net'

stages:
  - stage: Infrastructure
    displayName: 'Provisionar infraestructura en Azure'
    condition: eq(variables['deployInfra'], 'true')
    jobs:
      - job: DeployInfra
        displayName: 'Desplegar Bicep'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: AzureCLI@2
            displayName: 'az deployment group create'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                az deployment group create \
                  --name "$(Build.BuildNumber)-infra" \
                  --resource-group "$(resourceGroupName)" \
                  --template-file infra/azure/main.bicep \
                  --parameters \
                    environment=$(environment) \
                    namePrefix=$(namePrefix) \
                    location=$(location)

  - stage: Build
    displayName: 'Construir artefactos'
    jobs:
      - job: BuildBackend
        displayName: 'Backend'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Seleccionar Node.js'
          - script: |
              cd $(backendWorkingDirectory)
              npm install
              npm run lint
              npm run build --if-present
              npm prune --omit=dev
              zip -r ../backend.zip .
            displayName: 'Instalar y empaquetar backend'
          - publish: 'backend.zip'
            artifact: 'backend-package'
            displayName: 'Publicar backend.zip'

      - job: BuildFrontend
        displayName: 'Frontend'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Seleccionar Node.js'
          - script: |
              cd $(frontendWorkingDirectory)
              npm install
              VITE_API_BASE="$(frontendApiBaseUrl)" npm run build
            displayName: 'Instalar y construir frontend'
          - task: PublishBuildArtifacts@1
            displayName: 'Publicar artefacto frontend'
            inputs:
              PathtoPublish: '$(frontendWorkingDirectory)/dist'
              ArtifactName: 'frontend-dist'
              publishLocation: 'Container'

  - stage: Deploy
    displayName: 'Desplegar a Azure'
    dependsOn:
      - Build
    jobs:
      - deployment: DeployBackend
        displayName: 'Backend en App Service'
        environment: 'azure-backend-$(environment)'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: backend-package
                - task: AzureWebApp@1
                  displayName: 'Azure App Service Deploy'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    appType: 'webAppLinux'
                    appName: '$(backendWebAppName)'
                    package: '$(Pipeline.Workspace)/backend-package/backend.zip'
      - deployment: DeployFrontend
        displayName: 'Frontend en Azure Storage Static Website'
        environment: 'azure-frontend-$(environment)'
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: frontend-dist
                - task: AzureCLI@2
                  displayName: 'Subir sitio est√°tico'
                  inputs:
                    azureSubscription: '$(azureServiceConnection)'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az storage blob upload-batch \
                        --account-name $(frontendStorageAccount) \
                        --destination '$web' \
                        --source "$(Pipeline.Workspace)/frontend-dist" \
                        --overwrite
